create table users (
  id uuid primary key default gen_random_uuid(),
  clerk_id text unique not null,
  email text unique not null,
  subscription text not null default 'free',
  created_at timestamp default now()
);

CREATE TABLE user_search (
  id uuid PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  search_count_today int DEFAULT 0,
  last_search_date date
);


create table searches (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references users(id) on delete cascade,
  email text not null,
  breached boolean not null,
  breach_count int default 0,
  searched_at timestamp default now()
);

create table monitored_emails (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references users(id) on delete cascade,
  email text not null,
  last_breach_count int default 0,
  last_checked_at timestamp default now(),
  created_at timestamp default now(),
  unique(user_id, email)
);

create table subscriptions (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references users(id) on delete cascade,
  stripe_order_id text not null, -- cs_test_a1x5wDiymqdJAIAYY0uvrqRNOSjIt5OjOVD3f2iXDr5pRCbAK5gn87sEWv
  stripe_invoice_id text, -- in_1SZdcXGVzqmVv3a2DwHxAys5
  payment_status text not null default 'pending', -- pending, completed, failed
  subscription_status text not null default 'pending', -- active, cancelled, etc.
  stripe_status_text text not null,
  stripe_payment_status boolean not null, -- true for payment successful, false for all cases
  plan text not null default 'pro',
  plan_validity timestamp,
  created_at timestamp default now()
);


create table analytics_cache (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references users(id) on delete cascade,
  total_searches int default 0,
  total_breached int default 0,
  updated_at timestamp default now()
);
